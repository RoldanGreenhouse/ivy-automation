services:

  ca-server:
    depends_on:
      ca-postgres:
        condition: service_healthy
    image: smallstep/step-ca:0.29.0
    networks:
      greenhouse-infra:
        ipv4_address: ${greenhouse_ca_ip}
    container_name: ${ENV}-ca
    scale: ${greenhouse_scale_ca}
    # dns: ${greenhouse_adguard_ip}
    ports:
      - ${greenhouse_ca_port:-9000}:9000
    secrets:
      - step-ca_password
    environment:
      DOCKER_STEPCA_INIT_NAME: ${greenhouse_ca_config_name}
      DOCKER_STEPCA_INIT_DNS_NAMES: ${greenhouse_ca_config_dns_names}
      DOCKER_STEPCA_INIT_PROVISIONER_NAME: ${greenhouse_ca_config_provisioner_name:-admin}
      DOCKER_STEPCA_INIT_SSH: ${greenhouse_ca_config_ssh:-false}
      DOCKER_STEPCA_INIT_PASSWORD_FILE: /run/secrets/step-ca_password

      PGDATABASE: ${greenhouse_ca_postgres_db}
      PGUSER: ${greenhouse_ca_postgres_user}
      PGHOST: ca-postgres
      PGPORT: ${greenhouse_ca_postgres_port:-5432}
      PGPASSWORD : ${greenhouse_ca_postgres_password}
    volumes:
      - ${greenhouse_ca_volume_certs:-${PWD}/step-ca/${ENV}/certs}:/home/step/certs
      - ${greenhouse_ca_volume_secrets:-${PWD}/step-ca/${ENV}/secrets}:/home/step/secrets
      - ${greenhouse_ca_volume_config:-${PWD}/step-ca/${ENV}/config}:/home/step/config
      - ${greenhouse_ca_volume_db:-${PWD}/step-ca/${ENV}/db}:/home/step/db
      - ${greenhouse_ca_volume_main:-${PWD}/step-ca/${ENV}/main}:/home/step
    healthcheck:
      test:
        - CMD-SHELL
        - step ca health
      interval: 10s
      retries: 5
      start_period: 20s
      timeout: 10s
    restart: unless-stopped
    labels:
      traefik.enable: false
      traefik.docker.network: none

  ca-postgres:
    image: postgres:${greenhouse_ca_postgres_version:-${greenhouse_postgres_general_version:-18.1}}
    container_name: ${ENV}-ca-postgres
    scale: ${greenhouse_scale_ca:-0}
    networks:
      greenhouse-infra:
    ports:
      - ${greenhouse_ca_postgres_port:-5432}:${greenhouse_ca_postgres_port:-5432}
    environment:
      PGPORT: ${greenhouse_ca_postgres_port:-5432}
      POSTGRES_DB: ${greenhouse_ca_postgres_db}
      PGUSER: ${greenhouse_ca_postgres_user} # Required for the healthcheck
      POSTGRES_USER: ${greenhouse_ca_postgres_user}
      POSTGRES_PASSWORD: ${greenhouse_ca_postgres_password}
    volumes:
      - ${greenhouse_ca_postgres_vol:-${PWD}/step-ca-postgres}:/var/lib/postgresql
    restart: always
    healthcheck:
      test: 
        - CMD-SHELL
        - pg_isready -d $${POSTGRES_DB} -U $${PGUSER}
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    labels:
      traefik.enable: false

  adguard:
    image: adguard/adguardhome:v0.107.71
    networks:
      greenhouse-infra:
        ipv4_address: ${greenhouse_adguard_ip}
    container_name: ${ENV}-adguard
    scale: ${greenhouse_scale_adguard:-1}
    ports:
      # - 3000:3000 # Initial Config port. Remove comment only on initial setup.
      - 53:53/tcp # Adguard DNS
      - 53:53/udp # Adguard DNS
    volumes:
      - ${greenhouse_adguard_volume_work:-${PWD}/adguard/${ENV}/work}:/opt/adguardhome/work
      - ${greenhouse_adguard_volume_conf:-${PWD}/adguard/${ENV}/conf}:/opt/adguardhome/conf
      - ${greenhouse_ca_volume_certs:-${PWD}/step-ca/${ENV}/certs}:/opt/adguardhome/certs
    restart: unless-stopped
    labels:
      traefik.enable: true
      ### Web UI Router
      # ROUTER
      traefik.http.routers.adguard-ui.rule: Host(`${greenhouse_adguard_host:-adguard.${DOMAIN}}`)
      traefik.http.routers.adguard-ui.entrypoints: https
      traefik.http.routers.adguard-ui.tls.certresolver: greenhouse-resolver
      # SERVICE
      traefik.http.services.adguard-ui.loadbalancer.server.port: 80
      # MIDDLEWARE
      traefik.http.routers.adguard-ui.middlewares: authentik@docker

secrets:
  step-ca_password:
    file: ${greenhouse_ca_secret_password_filepath:-${PWD}/secrets/step-ca_password}